<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Prompts de Agentes Inteligentes - InteliChat</title>
    
    <!-- EasyMDE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Barra de Herramientas Global -->
        <header class="global-toolbar">
            <div class="toolbar-section-left">
                <span class="toolbar-title">Editor de Agentes</span>
                <div id="agentSelectorContainer" class="agent-selector-container">
                    <select id="clienteSelect" class="form-select"><option value="">Cliente...</option></select>
                    <select id="chatbotSelect" class="form-select" disabled><option value="">Chatbot...</option></select>
                    <select id="agenteSelect" class="form-select" disabled><option value="">Agente...</option></select>
                </div>
            </div>
            <div class="toolbar-section-right">
                <button id="savePrompt" class="btn btn-success" disabled>ğŸ’¾ Guardar</button>
                <button id="assistantBtn" class="btn btn-secondary">âœ¨ Asistente</button>
                <button id="validationBtn" class="btn btn-secondary">ğŸ§ª ValidaciÃ³n</button>
                <button id="helpBtn" class="btn btn-secondary">â“ Ayuda</button>
                <div class="theme-switch" title="Modo oscuro / claro">
                    <input type="checkbox" id="themeToggle"/>
                    <div class="track" id="themeTrack"><div class="thumb">ğŸŒ™</div></div>
                </div>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="main-content-grid">
            <!-- Ãrea de EdiciÃ³n Principal -->
            <section class="main-editor-area">
                <div class="main-tabs">
                    <button id="tabPrompt" class="main-tab-btn active">ğŸ“ Prompt</button>
                    <button id="tabParams" class="main-tab-btn">âš™ï¸ ParÃ¡metros</button>
                    <button id="tabMessages" class="main-tab-btn">ğŸ’¬ Mensajes</button>
                </div>
                <div class="main-tab-content">
                    <!-- Contenido PestaÃ±a Prompt -->
                    <div id="promptContent" class="main-tab-pane active">
                        <div class="editor-container">
                            <textarea id="promptEditor" placeholder="Selecciona un agente para cargar su system prompt..."></textarea>
                            <div id="autocompleteSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                        </div>
                        <div class="editor-actions">
                            <span id="saveStatus" class="save-status"></span>
                            <button id="resetPrompt" class="btn btn-warning" disabled>ğŸ”„ Resetear</button>
                        </div>
                    </div>
                    <!-- Contenido PestaÃ±a ParÃ¡metros -->
                    <div id="paramsContent" class="main-tab-pane form-container">
                        <div class="form-group">
                            <label for="temperatura">Temperatura</label>
                            <input type="number" id="temperatura" class="form-input" step="0.05" min="0" max="2">
                            <small>Controla la creatividad. Menor para respuestas predecibles, mayor para variedad.</small>
                        </div>
                        <div class="form-group">
                            <label for="top_p">Top P</label>
                            <input type="number" id="top_p" class="form-input" step="0.05" min="0" max="1">
                            <small>Controla el nÃºcleo de probabilidad de las palabras a considerar.</small>
                        </div>
                        <div class="form-group">
                            <label for="max_tokens">Max Tokens</label>
                            <input type="number" id="max_tokens" class="form-input" step="64" min="1">
                            <small>LÃ­mite mÃ¡ximo de tokens para la respuesta generada.</small>
                        </div>
                    </div>
                    <!-- Contenido PestaÃ±a Mensajes -->
                    <div id="messagesContent" class="main-tab-pane form-container">
                        <div class="form-group">
                            <label>Mensaje de Bienvenida</label>
                            <textarea id="mensaje_bienvenida_es" class="form-textarea" rows="3" placeholder="VersiÃ³n en espaÃ±ol..."></textarea>
                            <textarea id="mensaje_bienvenida_en" class="form-textarea" rows="3" placeholder="VersiÃ³n en inglÃ©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Retorno</label>
                            <textarea id="mensaje_retorno_es" class="form-textarea" rows="3" placeholder="VersiÃ³n en espaÃ±ol..."></textarea>
                            <textarea id="mensaje_retorno_en" class="form-textarea" rows="3" placeholder="VersiÃ³n en inglÃ©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Despedida</label>
                            <textarea id="mensaje_despedida_es" class="form-textarea" rows="3" placeholder="VersiÃ³n en espaÃ±ol..."></textarea>
                            <textarea id="mensaje_despedida_en" class="form-textarea" rows="3" placeholder="VersiÃ³n en inglÃ©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de ConfirmaciÃ³n de Handoff</label>
                            <textarea id="mensaje_handoff_confirmacion_es" class="form-textarea" rows="3" placeholder="VersiÃ³n en espaÃ±ol..."></textarea>
                            <textarea id="mensaje_handoff_confirmacion_en" class="form-textarea" rows="3" placeholder="VersiÃ³n en inglÃ©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Tarea Finalizada</label>
                            <textarea id="mensaje_final_tarea_es" class="form-textarea" rows="3" placeholder="VersiÃ³n en espaÃ±ol..."></textarea>
                            <textarea id="mensaje_final_tarea_en" class="form-textarea" rows="3" placeholder="VersiÃ³n en inglÃ©s..."></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panel Inspector (Derecha) -->
            <aside class="inspector-panel">
                <div class="inspector-section" id="agentInfo">
                    <h3>â„¹ï¸ Info del Agente</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
                <div class="inspector-section" id="recursosContent">
                    <h3>ğŸ› ï¸ Recursos</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
                <div class="inspector-section" id="handoffsContent">
                    <h3>ğŸ¤ Handoffs</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modales -->
    <div id="helpModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="helpModalClose" class="modal-close-btn">Ã—</button>
            <div id="helpModalText" class="modal-text-content">
                <h1>GuÃ­a de CreaciÃ³n de Prompts (Arquitectura v2)</h1>

                <section class="help-section">
                    <h2>FilosofÃ­a: El Prompt Conversa, el CÃ³digo Ejecuta</h2>
                    <p>En la nueva arquitectura, la responsabilidad del LLM es mÃ¡s simple y potente. Tu prompt ya no necesita describir flujos de control complejos. En su lugar, debe guiar al LLM para que haga dos cosas:</p>
                    <ol>
                        <li>Mantener una conversaciÃ³n fluida y natural con el usuario.</li>
                        <li>Declarar una <strong>intenciÃ³n</strong> clara en formato JSON cuando necesite realizar una acciÃ³n.</li>
                    </ol>
                    <p>El backend se encarga de interpretar esa intenciÃ³n y ejecutar la lÃ³gica de negocio correspondiente de forma segura y predecible.</p>
                </section>

                <section class="help-section">
                    <h2>Estructura de Salida JSON Obligatoria</h2>
                    <p>Toda respuesta del LLM debe ser un JSON con la siguiente estructura:</p>
                    <pre><code>{
    "say": "Mensaje para mostrar al usuario. Puede ser null si la acciÃ³n es silenciosa.",
    "action": { ... } // Objeto de acciÃ³n o null si solo se habla
}</code></pre>
                </section>

                <section class="help-section">
                    <h2>CatÃ¡logo de Intenciones (`action`)</h2>
                    <p>El objeto <code>action</code> le dice al sistema quÃ© hacer. Estas son las intenciones disponibles:</p>
                    
                    <div class="help-subsection">
                        <h3>1. Llamar a una Herramienta (Tool)</h3>
                        <p>Para ejecutar una API o un formulario.</p>
                        <pre><code>"action": {
    "type": "call_tool",
    "tool_name": "nombre_de_la_herramienta",
    "args": { "param1": "valor1", ... }
}</code></pre>
                        <p><strong>GuÃ­a:</strong> Puedes ver las herramientas disponibles para el agente actual en la pestaÃ±a <strong>ğŸ› ï¸ Recursos</strong>.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>2. Derivar a otro Agente (Handoff)</h3>
                        <p>Para pasar la conversaciÃ³n a otro agente especialista.</p>
                        <pre><code>"action": {
    "type": "handoff",
    "target_agent": "nombre_del_agente_destino"
}</code></pre>
                        <p><strong>GuÃ­a:</strong> Puedes ver los handoffs configurados en la pestaÃ±a <strong>ğŸ¤ Handoffs</strong>.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>3. Finalizar Turno (Â¡Clave para Especialistas!)</h3>
                        <p>Indica que un agente especialista ha completado su tarea y debe devolver el control al agente principal.</p>
                        <pre><code>"action": { "type": "finish_turn" }</code></pre>
                        <p><strong>Importante:</strong> Todo agente que no sea el principal (general/INFO) debe usar esta intenciÃ³n para finalizar su intervenciÃ³n.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>4. Guardar en SesiÃ³n</h3>
                        <p>Para almacenar o actualizar variables en el estado de la conversaciÃ³n.</p>
                        <pre><code>"action": {
    "type": "set_state",
    "payload": { "mi_variable": "valor", "otra_variable": 123 }
}</code></pre>
                    </div>

                    <div class="help-subsection">
                        <h3>5. Finalizar ConversaciÃ³n</h3>
                        <p>Para terminar el diÃ¡logo activamente.</p>
                        <pre><code>"action": { "type": "end_conversation" }</code></pre>
                    </div>
                </section>

                <section class="help-section">
                    <h2>Referencias y Variables</h2>
                    
                    <div class="help-subsection">
                        <h3>Uso de Mensajes Predefinidos</h3>
                        <p>No se referencian con cÃ³digo. El prompt debe instruir al LLM para que los use de forma semÃ¡ntica. El sistema se encarga de inyectar el texto correcto.</p>
                        <p><strong>Ejemplo de instrucciÃ³n en el prompt:</strong> <em>"Saluda al usuario con el mensaje de bienvenida y luego pregunta quÃ© necesita."</em></p>
                        <p><strong>GuÃ­a:</strong> Puedes ver y editar todos los mensajes en la pestaÃ±a <strong>ğŸ’¬ Mensajes</strong>.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>Uso de Variables de SesiÃ³n</h3>
                        <p>Puedes inyectar variables guardadas en la sesiÃ³n directamente en tus respuestas de texto.</p>
                        <p><strong>Sintaxis:</strong> Usa <code>${nombre_variable}</code> dentro del string del campo <code>say</code>.</p>
                        <pre><code>{
    "say": "Â¡Hola ${nombre_usuario}! Bienvenido de nuevo.",
    "action": null
}</code></pre>
                        <p><strong>Nota:</strong> Las variables se guardan con la intenciÃ³n <code>set_state</code>.</p>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <div id="assistantModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="assistantModalClose" class="modal-close-btn">Ã—</button>
            <div id="assistantModalText" class="modal-text-content">
                <div class="assistant-container">
                    <div class="suggestion-input-section">
                        <label for="userSuggestion">Â¿QuÃ© quieres mejorar o aÃ±adir?</label>
                        <div class="suggestion-input-wrapper">
                            <textarea id="userSuggestion" placeholder="Ej: 'hazlo mÃ¡s amigable', 'aÃ±ade un paso para verificar el email'..."></textarea>
                            <button id="micBtn" class="mic-btn" title="Grabar instrucciÃ³n por voz">ğŸ¤</button>
                        </div>
                        <button id="generateSuggestionBtn" class="btn btn-primary">ğŸš€ Generar Sugerencia</button>
                    </div>
                    <div class="suggestion-output-section">
                        <div class="suggestion-half">
                            <label>ğŸ“ Notas y Sugerencias</label>
                            <div id="suggestionNotes" class="suggestion-output-display"><div class="loader"></div><p class="empty-state">AquÃ­ aparecerÃ¡n las notas de la IA...</p></div>
                        </div>
                        <div class="suggestion-half">
                            <label>ğŸš€ Prompt Mejorado</label>
                            <div id="suggestionExample" class="suggestion-output-display"><div class="loader"></div><p class="empty-state">AquÃ­ aparecerÃ¡ el prompt mejorado...</p></div>
                            <div class="suggestion-actions">
                                <button id="applySuggestionBtn" class="btn btn-success" disabled>âœ… Aplicar al Editor</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="validationModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="validationModalClose" class="modal-close-btn">Ã—</button>
            <div id="validationModalText" class="modal-text-content">
                <div class="validation-controls">
                    <button id="runValidationBtn" class="btn btn-primary">ğŸ§ª Ejecutar ValidaciÃ³n</button>
                    <span id="validationStatus" class="save-status"></span>
                </div>
                <div id="validationReportContainer" class="validation-report-container">
                    <div class="empty-state">Haz clic en 'Ejecutar ValidaciÃ³n' para generar un nuevo informe.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- EasyMDE JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    
    <!-- Custom JS -->
    <script src="app.js"></script>
</body>
</html>
