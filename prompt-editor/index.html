<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Prompts de Agentes Inteligentes - InteliChat</title>
    
    <!-- EasyMDE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Barra de Herramientas Global -->
        <header class="global-toolbar">
            <div class="toolbar-section-left">
                <span class="toolbar-title">Editor de Agentes</span>
                <div class="lang-toggle" title="Seleccionar idioma del prompt">
                    <input type="checkbox" id="langToggle"/>
                    <div class="track" id="langTrack">
                        <div class="thumb">ESP</div>
                    </div>
                </div>
                <div id="agentSelectorContainer" class="agent-selector-container">
                    <select id="clienteSelect" class="form-select"><option value="">Cliente...</option></select>
                    <select id="chatbotSelect" class="form-select" disabled><option value="">Chatbot...</option></select>
                    <select id="agenteSelect" class="form-select" disabled><option value="">Agente...</option></select>
                </div>
            </div>
            <div class="toolbar-section-right">
                <button id="savePrompt" class="btn btn-success" disabled>üíæ Guardar</button>
                <button id="assistantBtn" class="btn btn-secondary">‚ú® Asistente</button>
                <button id="validationBtn" class="btn btn-secondary">üß™ Validaci√≥n</button>
                <button id="helpBtn" class="btn btn-secondary">‚ùì Ayuda</button>
                <div class="theme-switch" title="Modo oscuro / claro">
                    <input type="checkbox" id="themeToggle"/>
                    <div class="track" id="themeTrack"><div class="thumb">üåô</div></div>
                </div>
            </div>
        </header>

        <!-- Contenido Principal -->
        <main class="main-content-grid">
            <!-- √Årea de Edici√≥n Principal -->
            <section class="main-editor-area">
                <div class="main-tabs">
                    <button id="tabPrompt" class="main-tab-btn active">üìù Prompt</button>
                    <button id="tabParams" class="main-tab-btn">‚öôÔ∏è Par√°metros</button>
                    <button id="tabMessages" class="main-tab-btn">üí¨ Mensajes</button>
                </div>
                <div class="main-tab-content">
                    <!-- Contenido Pesta√±a Prompt -->
                    <div id="promptContent" class="main-tab-pane active">
                        <div class="editor-container">
                            <textarea id="promptEditor" placeholder="Selecciona un agente para cargar su system prompt..."></textarea>
                            <div id="autocompleteSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                        </div>
                        <div class="editor-actions">
                            <span id="saveStatus" class="save-status"></span>
                            <button id="resetPrompt" class="btn btn-warning" disabled>üîÑ Resetear</button>
                        </div>
                    </div>
                    <!-- Contenido Pesta√±a Par√°metros -->
                    <div id="paramsContent" class="main-tab-pane form-container">
                        <div class="form-group">
                            <label for="temperatura">Temperatura</label>
                            <input type="number" id="temperatura" class="form-input" step="0.05" min="0" max="2">
                            <small>Controla la creatividad. Menor para respuestas predecibles, mayor para variedad.</small>
                        </div>
                        <div class="form-group">
                            <label for="top_p">Top P</label>
                            <input type="number" id="top_p" class="form-input" step="0.05" min="0" max="1">
                            <small>Controla el n√∫cleo de probabilidad de las palabras a considerar.</small>
                        </div>
                        <div class="form-group">
                            <label for="max_tokens">Max Tokens</label>
                            <input type="number" id="max_tokens" class="form-input" step="64" min="1">
                            <small>L√≠mite m√°ximo de tokens para la respuesta generada.</small>
                        </div>
                    </div>
                    <!-- Contenido Pesta√±a Mensajes -->
                    <div id="messagesContent" class="main-tab-pane form-container">
                        <div class="form-group">
                            <label>Mensaje de Bienvenida</label>
                            <textarea id="mensaje_bienvenida_es" class="form-textarea" rows="3" placeholder="Versi√≥n en espa√±ol..."></textarea>
                            <textarea id="mensaje_bienvenida_en" class="form-textarea" rows="3" placeholder="Versi√≥n en ingl√©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Retorno</label>
                            <textarea id="mensaje_retorno_es" class="form-textarea" rows="3" placeholder="Versi√≥n en espa√±ol..."></textarea>
                            <textarea id="mensaje_retorno_en" class="form-textarea" rows="3" placeholder="Versi√≥n en ingl√©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Despedida</label>
                            <textarea id="mensaje_despedida_es" class="form-textarea" rows="3" placeholder="Versi√≥n en espa√±ol..."></textarea>
                            <textarea id="mensaje_despedida_en" class="form-textarea" rows="3" placeholder="Versi√≥n en ingl√©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Confirmaci√≥n de Handoff</label>
                            <textarea id="mensaje_handoff_confirmacion_es" class="form-textarea" rows="3" placeholder="Versi√≥n en espa√±ol..."></textarea>
                            <textarea id="mensaje_handoff_confirmacion_en" class="form-textarea" rows="3" placeholder="Versi√≥n en ingl√©s..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Mensaje de Tarea Finalizada</label>
                            <textarea id="mensaje_final_tarea_es" class="form-textarea" rows="3" placeholder="Versi√≥n en espa√±ol..."></textarea>
                            <textarea id="mensaje_final_tarea_en" class="form-textarea" rows="3" placeholder="Versi√≥n en ingl√©s..."></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Panel Inspector (Derecha) -->
            <aside class="inspector-panel">
                <div class="inspector-section" id="agentInfo">
                    <h3>‚ÑπÔ∏è Info del Agente</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
                <div class="inspector-section" id="recursosContent">
                    <h3>üõ†Ô∏è Recursos</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
                <div class="inspector-section" id="ragContent">
                    <h3>üîç RAG Cartuchos</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
                <div class="inspector-section" id="handoffsContent">
                    <h3>ü§ù Handoffs</h3>
                    <p class="empty-state">Selecciona un agente.</p>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modales -->
    <div id="helpModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="helpModalClose" class="modal-close-btn">√ó</button>
            <div id="helpModalText" class="modal-text-content">
                <h1>Gu√≠a de Creaci√≥n de Prompts (Arquitectura v2)</h1>

                <section class="help-section">
                    <h2>Filosof√≠a: El Prompt Conversa, el C√≥digo Ejecuta</h2>
                    <p>En la nueva arquitectura, la responsabilidad del LLM es m√°s simple y potente. Tu prompt ya no necesita describir flujos de control complejos. En su lugar, debe guiar al LLM para que haga dos cosas:</p>
                    <ol>
                        <li>Mantener una conversaci√≥n fluida y natural con el usuario.</li>
                        <li>Declarar una <strong>intenci√≥n</strong> clara en formato JSON cuando necesite realizar una acci√≥n.</li>
                    </ol>
                    <p>El backend se encarga de interpretar esa intenci√≥n y ejecutar la l√≥gica de negocio correspondiente de forma segura y predecible.</p>
                </section>

                <section class="help-section">
                    <h2>Estructura de Salida JSON Obligatoria</h2>
                    <p>Toda respuesta del LLM debe ser un JSON con la siguiente estructura:</p>
                    <pre><code>{
    "say": "Mensaje para mostrar al usuario. Puede ser null si la acci√≥n es silenciosa.",
    "action": { ... } // Objeto de acci√≥n o null si solo se habla
}</code></pre>
                </section>

                <section class="help-section">
                    <h2>Cat√°logo de Intenciones (`action`)</h2>
                    <p>El objeto <code>action</code> le dice al sistema qu√© hacer. Estas son las intenciones disponibles:</p>
                    
                    <div class="help-subsection">
                        <h3>1. Llamar a una Herramienta (Tool)</h3>
                        <p>Para ejecutar una API o un formulario.</p>
                        <pre><code>"action": {
    "type": "call_tool",
    "tool_name": "nombre_de_la_herramienta",
    "args": { "param1": "valor1", ... }
}</code></pre>
                        <p><strong>Gu√≠a:</strong> Puedes ver las herramientas disponibles para el agente actual en la pesta√±a <strong>üõ†Ô∏è Recursos</strong>.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>2. Derivar a otro Agente (Handoff)</h3>
                        <p>Para pasar la conversaci√≥n a otro agente especialista.</p>
                        <pre><code>"action": {
    "type": "handoff",
    "target_agent": "nombre_del_agente_destino"
}</code></pre>
                        <p><strong>Gu√≠a:</strong> Puedes ver los handoffs configurados en la pesta√±a <strong>ü§ù Handoffs</strong>.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>3. Finalizar Turno (¬°Clave para Especialistas!)</h3>
                        <p>Indica que un agente especialista ha completado su tarea y debe devolver el control al agente principal.</p>
                        <pre><code>"action": { "type": "finish_turn" }</code></pre>
                        <p><strong>Importante:</strong> Todo agente que no sea el principal (general/INFO) debe usar esta intenci√≥n para finalizar su intervenci√≥n.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>4. Guardar en Sesi√≥n</h3>
                        <p>Para almacenar o actualizar variables en el estado de la conversaci√≥n.</p>
                        <pre><code>"action": {
    "type": "set_state",
    "payload": { "mi_variable": "valor", "otra_variable": 123 }
}</code></pre>
                    </div>

                    <div class="help-subsection">
                        <h3>5. Consultar RAG (B√∫squeda en Conocimiento)</h3>
                        <p>Para buscar informaci√≥n en los cartuchos RAG disponibles.</p>
                        <pre><code>"action": {
    "type": "rag_query",
    "cartridge": "nombre_del_cartucho",
    "query": "consulta de b√∫squeda"
}</code></pre>
                        <p><strong>Gu√≠a:</strong> Puedes ver los cartuchos RAG disponibles en la pesta√±a <strong>üîç RAG Cartuchos</strong>.</p>
                        <p><strong>Ejemplo pr√°ctico:</strong></p>
                        <pre><code>{
    "say": "D√©jame buscar informaci√≥n sobre ese tema...",
    "action": {
        "type": "rag_query",
        "cartridge": "documentacion_productos",
        "query": "caracter√≠sticas del producto X"
    }
}</code></pre>
                    </div>

                    <div class="help-subsection">
                        <h3>6. Finalizar Conversaci√≥n</h3>
                        <p>Para terminar el di√°logo activamente.</p>
                        <pre><code>"action": { "type": "end_conversation" }</code></pre>
                    </div>
                </section>

                <section class="help-section">
                    <h2>Referencias y Variables</h2>
                    
                    <div class="help-subsection">
                        <h3>Uso de Mensajes Predefinidos</h3>
                        <p>No se referencian con c√≥digo. El prompt debe instruir al LLM para que los use de forma sem√°ntica. El sistema se encarga de inyectar el texto correcto.</p>
                        <p><strong>Ejemplo de instrucci√≥n en el prompt:</strong> <em>"Saluda al usuario con el mensaje de bienvenida y luego pregunta qu√© necesita."</em></p>
                        <p><strong>Gu√≠a:</strong> Puedes ver y editar todos los mensajes en la pesta√±a <strong>üí¨ Mensajes</strong>.</p>
                    </div>

                    <div class="help-subsection">
                        <h3>Uso de Variables de Sesi√≥n</h3>
                        <p>Puedes inyectar variables guardadas en la sesi√≥n directamente en tus respuestas de texto.</p>
                        <p><strong>Sintaxis:</strong> Usa <code>${nombre_variable}</code> dentro del string del campo <code>say</code>.</p>
                        <pre><code>{
    "say": "¬°Hola ${nombre_usuario}! Bienvenido de nuevo.",
    "action": null
}</code></pre>
                        <p><strong>Nota:</strong> Las variables se guardan con la intenci√≥n <code>set_state</code>.</p>
                    </div>
                </section>

                <section class="help-section">
                    <h2>Mejores Pr√°cticas con RAG</h2>
                    
                    <div class="help-subsection">
                        <h3>Cu√°ndo Usar RAG vs Tools vs Handoffs</h3>
                        <ul>
                            <li><strong>RAG:</strong> Para buscar informaci√≥n en documentos, manuales, bases de conocimiento.</li>
                            <li><strong>Tools:</strong> Para ejecutar acciones (crear, actualizar, enviar emails, etc.).</li>
                            <li><strong>Handoffs:</strong> Para derivar a agentes especializados en tareas espec√≠ficas.</li>
                        </ul>
                    </div>

                    <div class="help-subsection">
                        <h3>Combinando RAG con Otras Funcionalidades</h3>
                        <p>Puedes usar RAG junto con tools y handoffs en el mismo prompt:</p>
                        <pre><code>// Primero buscar informaci√≥n
{
    "say": "D√©jame consultar la documentaci√≥n...",
    "action": {
        "type": "rag_query",
        "cartridge": "manual_usuario",
        "query": "proceso de instalaci√≥n"
    }
}

// Luego ejecutar una acci√≥n basada en esa informaci√≥n
{
    "say": "Bas√°ndome en la documentaci√≥n, voy a crear tu ticket...",
    "action": {
        "type": "call_tool",
        "tool_name": "crear_ticket",
        "args": { "categoria": "instalacion" }
    }
}</code></pre>
                    </div>

                    <div class="help-subsection">
                        <h3>Optimizaci√≥n de Consultas RAG</h3>
                        <ul>
                            <li>Usa consultas espec√≠ficas y descriptivas</li>
                            <li>Incluye contexto relevante en la consulta</li>
                            <li>Combina m√∫ltiples consultas para informaci√≥n compleja</li>
                        </ul>
                        <p><strong>Ejemplo:</strong> En lugar de "producto X", usa "caracter√≠sticas t√©cnicas del producto X modelo 2024"</p>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <div id="assistantModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="assistantModalClose" class="modal-close-btn">√ó</button>
            <div id="assistantModalText" class="modal-text-content">
                <div class="assistant-container">
                    <div class="suggestion-input-section">
                        <label for="userSuggestion">¬øQu√© quieres mejorar o a√±adir?</label>
                        <div class="suggestion-input-wrapper">
                            <textarea id="userSuggestion" placeholder="Ej: 'hazlo m√°s amigable', 'a√±ade un paso para verificar el email'..."></textarea>
                            <button id="micBtn" class="mic-btn" title="Grabar instrucci√≥n por voz">üé§</button>
                        </div>
                        <button id="generateSuggestionBtn" class="btn btn-primary">üöÄ Generar Sugerencia</button>
                    </div>
                    <div class="suggestion-output-section">
                        <div class="suggestion-half">
                            <label>üìù Notas y Sugerencias</label>
                            <div id="suggestionNotes" class="suggestion-output-display"><div class="loader"></div><p class="empty-state">Aqu√≠ aparecer√°n las notas de la IA...</p></div>
                        </div>
                        <div class="suggestion-half">
                            <label>üöÄ Prompt Mejorado</label>
                            <div id="suggestionExample" class="suggestion-output-display"><div class="loader"></div><p class="empty-state">Aqu√≠ aparecer√° el prompt mejorado...</p></div>
                            <div class="suggestion-actions">
                                <button id="applySuggestionBtn" class="btn btn-success" disabled>‚úÖ Aplicar al Editor</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="validationModalOverlay" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="validationModalClose" class="modal-close-btn">√ó</button>
            <div id="validationModalText" class="modal-text-content">
                <div class="validation-controls">
                    <button id="runValidationBtn" class="btn btn-primary">üß™ Ejecutar Validaci√≥n</button>
                    <span id="validationStatus" class="save-status"></span>
                </div>
                <div id="validationReportContainer" class="validation-report-container">
                    <div class="empty-state">Haz clic en 'Ejecutar Validaci√≥n' para generar un nuevo informe.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- EasyMDE JS -->
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    
    <!-- Custom JS -->
    <script src="app.js"></script>
</body>
</html>
